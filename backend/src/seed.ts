import { PrismaClient } from '@prisma/client'

const prisma = new PrismaClient()

async function main() {
  console.log('üå± D√©but du seeding de la base de donn√©es...')
  
  try {
    // Supprimer toutes les donn√©es existantes
    console.log('‚ö†Ô∏è Des donn√©es existent d√©j√† dans la base. Suppression...')
    await prisma.activity.deleteMany()
    await prisma.userProfile.deleteMany()
    await prisma.userSession.deleteMany()
    await prisma.account.deleteMany()
    
    // Cr√©er les comptes de test
    const testAccounts = [
      {
        email: 'demo@katiopa.com',
        subscriptionType: 'FREE',
        maxSessions: 2,
        totalAccountConnectionDurationMs: BigInt(0)
      },
      {
        email: 'pro@katiopa.com',
        subscriptionType: 'PRO',
        maxSessions: 4,
        totalAccountConnectionDurationMs: BigInt(0)
      },
      {
        email: 'premium@katiopa.com',
        subscriptionType: 'PRO_PLUS',
        maxSessions: 6,
        totalAccountConnectionDurationMs: BigInt(0)
      }
    ]

    const createdAccounts = await Promise.all(
      testAccounts.map(account => prisma.account.create({ data: account }))
    )
    console.log('‚úÖ Comptes de test cr√©√©s:', createdAccounts.length)

    // Cr√©er les sessions utilisateur
    const testSessions = await Promise.all([
      // Compte FREE - Famille Dupont
      prisma.userSession.create({
        data: {
          accountId: createdAccounts[0].id,
          sessionId: 'MARIE_DUPONT',
          password: 'password123',
          firstName: 'Marie',
          lastName: 'Dupont',
          gender: 'FEMALE',
          userType: 'PARENT',
          age: 32,
          grade: 'N/A',
          country: 'France',
          timezone: 'Europe/Paris',
          isActive: true,
          totalConnectionDurationMs: BigInt(1800000), // 30 minutes
          lastLoginAt: new Date()
        }
      }),
      prisma.userSession.create({
        data: {
          accountId: createdAccounts[0].id,
          sessionId: 'LUCAS_005',
          password: 'password123',
          firstName: 'Lucas',
          lastName: 'Dupont',
          gender: 'MALE',
          userType: 'CHILD',
          age: 5,
          grade: 'GS',
          country: 'France',
          timezone: 'Europe/Paris',
          isActive: true,
          totalConnectionDurationMs: BigInt(3600000), // 1 heure
          lastLoginAt: new Date()
        }
      }),

      // Compte PRO - Famille Martin
      prisma.userSession.create({
        data: {
          accountId: createdAccounts[1].id,
          sessionId: 'PATRICK_MARTIN',
          password: 'password123',
          firstName: 'Patrick',
          lastName: 'Martin',
          gender: 'MALE',
          userType: 'PARENT',
          age: 35,
          grade: 'N/A',
          country: 'France',
          timezone: 'Europe/Paris',
          isActive: true,
          totalConnectionDurationMs: BigInt(2400000), // 40 minutes
          lastLoginAt: new Date()
        }
      }),
      prisma.userSession.create({
        data: {
          accountId: createdAccounts[1].id,
          sessionId: 'EMMA_006',
          password: 'password123',
          firstName: 'Emma',
          lastName: 'Martin',
          gender: 'FEMALE',
          userType: 'CHILD',
          age: 6,
          grade: 'CP',
          country: 'France',
          timezone: 'Europe/Paris',
          isActive: true,
          totalConnectionDurationMs: BigInt(5400000), // 1h30
          lastLoginAt: new Date()
        }
      }),
      prisma.userSession.create({
        data: {
          accountId: createdAccounts[1].id,
          sessionId: 'THOMAS_007',
          password: 'password123',
          firstName: 'Thomas',
          lastName: 'Martin',
          gender: 'MALE',
          userType: 'CHILD',
          age: 7,
          grade: 'CE1',
          country: 'France',
          timezone: 'Europe/Paris',
          isActive: true,
          totalConnectionDurationMs: BigInt(4800000), // 1h20
          lastLoginAt: new Date()
        }
      }),

      // Compte PRO_PLUS - Famille Bernard
      prisma.userSession.create({
        data: {
          accountId: createdAccounts[2].id,
          sessionId: 'SOPHIE_BERNARD',
          password: 'password123',
          firstName: 'Sophie',
          lastName: 'Bernard',
          gender: 'FEMALE',
          userType: 'PARENT',
          age: 38,
          grade: 'N/A',
          country: 'France',
          timezone: 'Europe/Paris',
          isActive: true,
          totalConnectionDurationMs: BigInt(3000000), // 50 minutes
          lastLoginAt: new Date()
        }
      }),
      prisma.userSession.create({
        data: {
          accountId: createdAccounts[2].id,
          sessionId: 'JULIA_004',
          password: 'password123',
          firstName: 'Julia',
          lastName: 'Bernard',
          gender: 'FEMALE',
          userType: 'CHILD',
          age: 4,
          grade: 'MS',
          country: 'France',
          timezone: 'Europe/Paris',
          isActive: true,
          totalConnectionDurationMs: BigInt(2400000), // 40 minutes
          lastLoginAt: new Date()
        }
      }),
      prisma.userSession.create({
        data: {
          accountId: createdAccounts[2].id,
          sessionId: 'ALEX_008',
          password: 'password123',
          firstName: 'Alex',
          lastName: 'Bernard',
          gender: 'MALE',
          userType: 'CHILD',
          age: 8,
          grade: 'CE2',
          country: 'France',
          timezone: 'Europe/Paris',
          isActive: true,
          totalConnectionDurationMs: BigInt(6000000), // 2 heures
          lastLoginAt: new Date()
        }
      })
    ])
    console.log('‚úÖ Sessions utilisateur cr√©√©es:', testSessions.length)

    // Mettre √† jour les temps totaux des comptes
    await Promise.all(createdAccounts.map(async (account, index) => {
      const accountSessions = testSessions.filter(s => s.accountId === account.id)
      const totalTime = accountSessions.reduce((sum, session) => sum + Number(session.totalConnectionDurationMs), 0)
      
      await prisma.account.update({
        where: { id: account.id },
        data: { totalAccountConnectionDurationMs: BigInt(totalTime) }
      })
    }))

    // Cr√©er des profils utilisateur pour les enfants
    const childSessions = testSessions.filter(s => s.userType === 'CHILD')
    await Promise.all([
      prisma.userProfile.create({
        data: {
          userSessionId: childSessions[0].id, // Lucas (5 ans)
          learningGoals: ['Reconna√Ætre les lettres', 'Compter jusqu\'√† 10'],
          preferredSubjects: ['Fran√ßais', 'Math√©matiques'],
          learningStyle: 'Visuel',
          difficulty: 'D√©butant',
          interests: ['Animaux', 'Couleurs', 'Musique'],
          specialNeeds: [],
          customNotes: 'Lucas aime les histoires avec des animaux',
          parentWishes: 'D√©velopper la curiosit√©'
        }
      }),
      prisma.userProfile.create({
        data: {
          userSessionId: childSessions[1].id, // Emma (6 ans)
          learningGoals: ['Ma√Ætriser les additions', 'Lire des mots simples'],
          preferredSubjects: ['Math√©matiques', 'Fran√ßais'],
          learningStyle: 'Auditif',
          difficulty: 'D√©butant',
          interests: ['Nature', 'Dessin', 'Danse'],
          specialNeeds: [],
          customNotes: 'Emma adore les activit√©s cr√©atives',
          parentWishes: 'Renforcer la confiance en soi'
        }
      }),
      prisma.userProfile.create({
        data: {
          userSessionId: childSessions[2].id, // Thomas (7 ans)
          learningGoals: ['Tables de multiplication', 'Compr√©hension de lecture'],
          preferredSubjects: ['Math√©matiques', 'Sciences'],
          learningStyle: 'Kinesth√©sique',
          difficulty: 'Interm√©diaire',
          interests: ['Espace', 'Dinosaures', 'Construction'],
          specialNeeds: [],
          customNotes: 'Thomas aime les d√©fis et les √©nigmes',
          parentWishes: 'D√©velopper la logique'
        }
      }),
      prisma.userProfile.create({
        data: {
          userSessionId: childSessions[3].id, // Julia (4 ans)
          learningGoals: ['Reconna√Ætre les formes', 'Compter jusqu\'√† 5'],
          preferredSubjects: ['Math√©matiques', 'Arts'],
          learningStyle: 'Visuel',
          difficulty: 'Tr√®s d√©butant',
          interests: ['Poup√©es', 'Peinture', 'Chansons'],
          specialNeeds: [],
          customNotes: 'Julia a une grande imagination',
          parentWishes: 'Encourager la cr√©ativit√©'
        }
      }),
      prisma.userProfile.create({
        data: {
          userSessionId: childSessions[4].id, // Alex (8 ans)
          learningGoals: ['Division simple', 'R√©daction de textes'],
          preferredSubjects: ['Math√©matiques', 'Histoire'],
          learningStyle: 'Logique',
          difficulty: 'Avanc√©',
          interests: ['Moyen √Çge', 'Chess', 'Astronomie'],
          specialNeeds: [],
          customNotes: 'Alex est tr√®s curieux et pose beaucoup de questions',
          parentWishes: 'Nourrir sa curiosit√© intellectuelle'
        }
      })
    ])
    console.log('‚úÖ Profils utilisateur cr√©√©s')

    // Cr√©er des activit√©s d'apprentissage vari√©es avec des scores et dur√©es r√©alistes
    const activitiesData = [
      // Lucas (5 ans) - Niveau d√©butant
      { userSessionId: childSessions[0].id, domain: 'maths', nodeKey: 'maths.counting.1to10', score: 80, attempts: 2, durationMs: 15000 },
      { userSessionId: childSessions[0].id, domain: 'francais', nodeKey: 'francais.letters.vowels', score: 75, attempts: 3, durationMs: 20000 },
      
      // Emma (6 ans) - Niveau d√©butant
      { userSessionId: childSessions[1].id, domain: 'maths', nodeKey: 'maths.addition.1digit', score: 85, attempts: 2, durationMs: 18000 },
      { userSessionId: childSessions[1].id, domain: 'francais', nodeKey: 'francais.reading.simple_words', score: 90, attempts: 1, durationMs: 12000 },
      { userSessionId: childSessions[1].id, domain: 'sciences', nodeKey: 'sciences.nature.animals', score: 88, attempts: 2, durationMs: 16000 },
      
      // Thomas (7 ans) - Niveau interm√©diaire
      { userSessionId: childSessions[2].id, domain: 'maths', nodeKey: 'maths.multiplication.table2', score: 92, attempts: 1, durationMs: 14000 },
      { userSessionId: childSessions[2].id, domain: 'maths', nodeKey: 'maths.subtraction.2digit', score: 78, attempts: 3, durationMs: 22000 },
      { userSessionId: childSessions[2].id, domain: 'sciences', nodeKey: 'sciences.space.planets', score: 95, attempts: 1, durationMs: 10000 },
      
      // Julia (4 ans) - Niveau tr√®s d√©butant
      { userSessionId: childSessions[3].id, domain: 'maths', nodeKey: 'maths.shapes.basic', score: 70, attempts: 4, durationMs: 25000 },
      { userSessionId: childSessions[3].id, domain: 'arts', nodeKey: 'arts.colors.primary', score: 85, attempts: 2, durationMs: 18000 },
      
      // Alex (8 ans) - Niveau avanc√©
      { userSessionId: childSessions[4].id, domain: 'maths', nodeKey: 'maths.division.simple', score: 88, attempts: 2, durationMs: 16000 },
      { userSessionId: childSessions[4].id, domain: 'history', nodeKey: 'history.medieval.knights', score: 96, attempts: 1, durationMs: 8000 },
      { userSessionId: childSessions[4].id, domain: 'coding', nodeKey: 'coding.logic.sequences', score: 82, attempts: 3, durationMs: 20000 }
    ]

    await prisma.activity.createMany({ data: activitiesData })
    console.log('‚úÖ Activit√©s d\'apprentissage cr√©√©es:', activitiesData.length)

    // Seed des plan seats (V2 minimal, d√©sormais support√© par schema.prisma)
    console.log('üîÑ Cr√©ation des plan seats pour la v2...')
    const { seedPlanSeats } = await import('./db/seedPlanSeats')
    await seedPlanSeats()
    console.log('‚úÖ Plan seats cr√©√©s/mis √† jour avec succ√®s')

    console.log('üéâ Seeding termin√© avec succ√®s!')
    console.log('\nüìã Comptes de test disponibles:')
    console.log('\nüÜì Compte FREE (demo@katiopa.com):')
    console.log('  üë®‚Äçüë©‚Äçüë¶ Session: MARIE_DUPONT / password123 (Parent)')
    console.log('  üë¶ Session: LUCAS_005 / password123 (Enfant, 5 ans)')
    
    console.log('\n‚≠ê Compte PRO (pro@katiopa.com):')
    console.log('  üë® Session: PATRICK_MARTIN / password123 (Parent)')
    console.log('  üëß Session: EMMA_006 / password123 (Enfant, 6 ans)')
    console.log('  üë¶ Session: THOMAS_007 / password123 (Enfant, 7 ans)')
    
    console.log('\nüíé Compte PRO_PLUS (premium@katiopa.com):')
    console.log('  üë© Session: SOPHIE_BERNARD / password123 (Parent)')
    console.log('  üëß Session: JULIA_004 / password123 (Enfant, 4 ans)')
    console.log('  üë¶ Session: ALEX_008 / password123 (Enfant, 8 ans)')

  } catch (error) {
    console.error('‚ùå Erreur lors du seeding:', error)
    throw error
  }
}

main()
  .catch((e) => {
    console.error('‚ùå Erreur fatale:', e)
    process.exit(1)
  })
  .finally(async () => {
    await prisma.$disconnect()
  })
